# もう一回 redis を使ってみる（2）

## 概要

 * redis サーバーをレプリケーション環境で構築してみる
 * fluentd のストレージとして利用してみる

## 前回まで

以下を行った。

 * ソースコードからコンパイルしてのインストール
 * デーモンモードでの稼働
 * データを書き出すディレクトリの設定
 * 適当にデータを突っ込んでみる

## 今回は…

実運用を検討する上で、以下の点を検証してみる。

 * レプリケーションとクラスタリング
 * バックアップとレストア
 * fluentd のストレージとして

## レプリケーションとクラスタリング

 * レプリケーションと proxy を利用したクラスタリングを構成することが可能
 * クラスタリングはバージョン 2.6 以降では標準実装されているらしいけど、今回は検証は割愛（すんません）

### レプリケーションの設定

レプリケーションは比較的簡単に行える。スレーブ側の `redis.conf` に以下を記載し `redis-server`  を起動する。

```
slaveof xxx.xxx.xxx.xxx 6379
```

正常に起動した場合には下記のようなログがスレーブ側に出力される。

```
[3938] 15 Jun 14:23:24.549 * Connecting to MASTER...                            
[3938] 15 Jun 14:23:24.549 * MASTER <-> SLAVE sync started                      
[3938] 15 Jun 14:23:24.552 * Non blocking connect for SYNC fired the event.     
[3938] 15 Jun 14:23:24.553 * Master replied to PING, replication can continue...
[3938] 15 Jun 14:23:24.576 * MASTER <-> SLAVE sync: receiving 93 bytes from mast
er                                                                              
[3938] 15 Jun 14:23:24.576 * MASTER <-> SLAVE sync: Loading DB in memory        
[3938] 15 Jun 14:23:24.576 * MASTER <-> SLAVE sync: Finished with success       
```

マスター側のキーを確認してみる。

```
redis 127.0.0.1:6379> keys *
1) "q"                      
2) "b"                      
3) "huga"                   
4) "h"                      
5) "p"                      
6) "inokara"                
7) "w"                      
8) "kappa"                  
9) "a"
redis 127.0.0.1:6379> get inokara 
"ahoaho"                                         
```

上記を元にスレーブ側でレプリケーションされた key value を確認してみる。

```
redis 127.0.0.1:6379> get inokara
"ahoaho"                         
```

マスター側にデータを突っ込んでスレーブ側で `key` を指定してデータを取り出すスクリーンショット。



うん、簡単。

### レプリケーションの疑問

 * 暫く運用していたマスターにスレーブを追加した場合、どの時点からのデータを同期してくれるのか？
 * うっかりスレーブに書き込んでしまった場合の対処は？
 * マスターがぶっ壊れてしまった場合の対処は？

## バックアップとレストア

### バックアップ

### レストア

## fluentd のストレージとして

### 検証の環境

### 設定

### データを取り出してみる…Ruby で

## まとめ
