# knife xenserver で Xenserver を三枚におろす一部始終（リターンズ）

***

## 概要

 * 以前に試した [knife-xensever](https://github.com/bvox/knife-xenserver) を改めて試してみる
 * [前回](http://inokara.hateblo.jp/entry/2013/04/14/094554)は XenServer の調子が悪くて断念してしまったこともあり、改めて、knife-xenserver と chef を利用したサーバーの構築を行なってみたい

***

## knife-xensever

### 概要

github の README に `Provision virtual machines with Citrix XenServer and Opscode Chef.` とある通り、XenServer と chef を使って仮想マシンのプロビジョニングを行う knife のプラグイン。残念ながら活発には開発が行われていないようで、どのソースも半年くらい前で開発が止まってしまっている。

### 出来ること

 * XenServer に登録されている仮想サーバー及びテンプレートの一覧取得
 * テンプレートからの VM 作成
 * [xenserver-automater](https://github.com/krobertson/xenserver-automater) と絡めることで IP アドレスの設定等も行うことが出来る

### 技術的なメモ（ fog について）

 * XenServer へのアクセスは [fog](https://github.com/fog/fog) が XenAPI を叩いてくれている（という認識）
 * `fog` は ruby の仮想環境にアクセスする為のライブラリ

```ruby
 12     service(:compute, 'xenserver/compute', 'Compute')
 13 
 14     class Connection
 15       require 'xmlrpc/client'
 16 
 17       def initialize(host)
 18         @factory = XMLRPC::Client.new(host, '/')
 19         @factory.set_parser(NokogiriStreamParser.new)
 20       end
```

一応、`fog` のソースコードを見てみると `fog-1.11.1/lib/fog/xenserver.rb` で以下の通り `xmlrpc/client` を require していることからも XenAPI を http 経由で叩いているようだ。

***

## knife-xenserver を使ってみる

### knife-xenserver のインストール

gem で一発！

```
sudo gem install knife-xenserver --no-ri --no-droc
```

その他、必要な gem もズラズラインストールされる。もちろん fog もインストールされる。

```
Fetching: terminal-table-1.4.5.gem (100%)
Fetching: builder-3.2.0.gem (100%)
Fetching: excon-0.22.1.gem (100%)
Fetching: formatador-0.2.4.gem (100%)
Fetching: net-scp-1.1.1.gem (100%)
Fetching: ruby-hmac-0.4.0.gem (100%)
Fetching: fog-1.11.1.gem (100%)
Fetching: colored-1.2.gem (100%)
Fetching: uuidtools-2.1.4.gem (100%)
Fetching: knife-xenserver-1.2.3.gem (100%)
Successfully installed terminal-table-1.4.5
Successfully installed builder-3.2.0
Successfully installed excon-0.22.1
Successfully installed formatador-0.2.4
Successfully installed net-scp-1.1.1
Successfully installed ruby-hmac-0.4.0
Successfully installed fog-1.11.1
Successfully installed colored-1.2
Successfully installed uuidtools-2.1.4
Successfully installed knife-xenserver-1.2.3
10 gems installed
```
