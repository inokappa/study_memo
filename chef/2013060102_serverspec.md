# serverspec を実際の運用でどのように使うかを考えてみた

## 概要

 * [前回](http://inokara.hateblo.jp/entry/2013/06/02/011833) redis サーバーをインストールしたホストを serverspec を使ってテストしてみた
 * ということで、今回は serverspec を運用でどのように使うかをとある仮想の現場を題材に考えてみる

## 参考

今回は下記を参考にさせて頂きました。

 * [http://serverspec.org/](http://serverspec.org/)
 * [serverspecでZabbixサーバの稼働テストを書いてみた](http://d.hatena.ne.jp/ike-dai/20130514/1368534178)
  
## serverspec についての認識

 * [こちら](http://mizzy.org/blog/2013/03/23/1/)に書かれているようにサーバー上で稼働しているサービスや開いているポート等をテストするツール
 * 対象となるホストに対して SSH でアクセスするので物理サーバーでも仮想サーバーでもテストが可能

## 実際の運用（現場について）

実際に serverspec を利用することを想定した仮想現場の状況ついて整理してみる。

### サーバーで使っている OS

 * CentOS

### サーバーパーティションの状態

 * / パーティション以外に /boot が存在すること

### サーバーの詳細設定

 * ホスト名は `vm01.xen.inokara.com` となっていること
 * selinux は `disabled` となっていること

### サーバー上で稼働しているべきサービス

 * SSH（ポートは 22 番で稼働）
 * MySQL
 * postfix
 * Apache（ポート 80 番で稼働しており、/etc/httpd/conf.d/welcome.conf が無効になっていること）


### サーバー上で稼働するべきではないサービス

 * iptables

## テストを書く

整理した内容を元にいテストを書いていく。

`spec/host1/default_spec.rb`

```ruby
require 'spec_helper'                         
                                              
# OS checking                                 
describe file('/etc/redhat-release') do       
  it { should contain 'CentOS' }              
end                                           
                                              
# checking hostname                           
describe file('/etc/sysconfig/network') do    
  it { should contain 'vm01.xen.inokara.com' }
end                                           
                                              
# SELinux should be disabled                  
describe selinux do                           
  it { should be_disabled }                   
end                                           
```


## まとめ

 * 当初 `should_not` の存在を確認しないまま [issue](https://github.com/mizzy/serverspec/issues/135) を出してしまった...
 * すぐに[コメント](https://github.com/mizzy/serverspec/issues/135#issuecomment-18800942)を頂き解決出来た
 * コメント頂いた [Tomohiro](https://github.com/Tomohiro) さんに感謝！
