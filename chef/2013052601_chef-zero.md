# chef-zero を使ってみる

***

## 概要

 * 簡易軽量 Chef Server の [chef-zero](https://github.com/jkeiser/chef-zero) を使ってみる
 * 構築にあたっては[こちら](http://www.creationline.com/lab/2749)を参考にさせて頂いた
 * 構築後は knife xenserver から利用してみることにする

***

## 環境

| 役割 | 名前 | 環境 |
|----- |------|-----|
| Chef Server | chef-zero | Debian 7 / apt-get にて ruby と ruby-dev をインストール |
| Chef Client | XenServer 上の VM | CentOS 6.4 |
| Workstation | X1Carbon | Debian 7 |

***

## 構築

### 必要なパッケージのインストール

```
apt get install ruby ruby-dev libssl-dev
```

### gem にてインストール

```
gem install chef-zero --no-ri --no-rdoc
```

```
Building native extensions.  This could take a while...
Fetching: mixlib-log-1.6.0.gem (100%)
Fetching: hashie-2.0.5.gem (100%)
Fetching: moneta-0.6.0.gem (100%)
Fetching: chef-zero-1.0.1.gem (100%)
Successfully installed puma-2.0.1
Successfully installed mixlib-log-1.6.0
Successfully installed hashie-2.0.5
Successfully installed moneta-0.6.0
Successfully installed chef-zero-1.0.1
5 gems installed
```
インストール出来た。

ヘルプを確認してみる。

```
root@debian:~# chef-zero -h
Usage: chef-zero [ARGS]
    -H, --host HOST                  Host to bind to (default: 127.0.0.1)
    -p, --port PORT                  Port to listen on
        --[no-]generate-keys         Whether to generate actual keys or fake it (faster).  Default: false.
    -l, --log-level LEVEL            Set the output log level
    -h, --help                       Show this message
        --version                    Show version
```

デフォルトはローカルホストのみのアクセスを受け付けるとのことなので全てのホストからアクセスを受けつけるように `-H` オプションで `0.0.0.0` を指定して chef-zero を起動する。

```
chef-zero -H 0.0.0.0
```

```
>> Starting Chef Zero (v1.0.1)...
>> Puma (v2.0.1) is listening at http://0.0.0.0:8889
>> Press CTRL+C to stop
```

Web サーバー（puma）が 8889 番で Listen して起動する。ちなみに [puma](https://github.com/puma/puma) は EngineYard のプロジェクトの ruby の Web サーバーで puma の名のごとく動作が速いのが売りらしく、[公式サイト](http://puma.io/)では消費メモリが他の Web サーバー（Unicorn 等）より少ないのも特徴らしい。 

### 初期設定

knife.rb の `chef_server_url` に chef-zero の IP アドレスとポートを指定する。

```
chef_server_url          "http://xxx.xxx.xxx.xxx:8889"
```

chef-zero は @urasako さんが[こちら](http://slid.es/urasoko/chef-zero)で書かれている通り、認証が不要とのことで、`client_key` や `validation_key` 等を無効化してみて試したところ、`client_key` を無効化してみると...

```
knife client list
```

```
ERROR: Your private key could not be loaded from /etc/chef/client.pem
Check your configuration file and ensure that your private key is readable
```

こんな感じでエラーとなるので `client_key` の設定は必須のようだ。

動作確認の為 `knife client list` を実行してみる。

```
knife client list
```

```
chef-validator
chef-webui
```

上記の通り正常に結果が返ってくる。

### cookbook をアップロードしてみる

以前に Hosted Chef に登録した hoge_cookbook を少し弄って登録してみる。

```
vim hoge_cookbook/templates/default/config.conf.erb
```

chef-zero で設定されたことが判るように...

```
welcome to chef-zero
```

そして chef-zero にアップロードする。

```
cd ${chef-repo}
knife cookbook upload hoge_cookbook -o ./
```

アップロード出来たようだ。

```
Uploading hoge_cookbook  [0.1.2]
Uploaded 1 cookbook.
```

念の為、登録されている cookbook を確認してみる。

```
knife cookbook list
```

アップロードされている。

```
hoge_cookbook   0.1.2
```

Hosted Chef と表示のされ方が若干異なる。

***

## knife xenserver との連携 

