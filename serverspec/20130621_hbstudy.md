# hbstudy serverspecが拓いたサーバテストの世界

## 自己紹介

 * 学生
 * puppet のススメ
 * 子沢山

## サーバープロビジョニング

### Provisioning Toolchain

 * Bootstrapping
 * Coniguration（puppet chef）-> serverspec
 * Orchestration（capistrano…）-> Nagios zabbix

### サーバープロビジョニングとテスト

 * 監視とは継続的なテストである
 * zabbix や Nagios で apache を監視する場合
 * serverspec で apache を監視する場合
  * httpd プロセスが動いているか？
  * 自動起動するか？
  * パッケージがインストールされているか？
 * configuration のテスト
 * Nagios とか Zabbix があれば servespec は不要論

## Configuration とテスト

### serverspec 登場前？

 * シェル叩く
 * ブラウザでアクセスする
 
## configuration management framework

 * puppet
 * chef
 * ansible works（？）
  * オーケストレイヤーも含む？

## configuration management framework と test

 * 従来はシェル

### この界隈はテスト・ツールが乱立？

 * シンタックステスト
  * foodcritic
  * cookbook test
  
 * ユニットテスト
  * Chefspec（ユニットテスト）
  * rspec-puppet（ユニットテスト）
  * 実際には適用しない
  * ユニットテスト要不要？
  * 複雑なモノであれば威力を発揮→ユニットテスト
 
 * 結合テスト
  * serverspec
  * test kitchen
  * cucumber chef

 * Instructure as code は自然の流れ

### なぜ、serverspec を作ったか？

 * 既存のツールは機能が多い
 * 特定の環境に依存しない
 * test-kitchen と serverspec の組み合わせが良いらしい
 
### puppet や chef を使っていて servespec が必要か？

 * 一度書いたマニフェストやレシピを更新しないのであれば不要（たぶん）
 * 継続的に更新するなら必要
 * プログラムのリファクタリングと一緒
 * テストの自動化が必要
 * 自動化するならコードに落としこむ
 * テストコード自体のメンテナンスも必要
 * テストコードの読みやすさ、テストツール自体のシンプルさも重要

## serverspec

 * サーバーのテストを簡潔に書くための仕組み
 * rspec で記述
 * rspec は ruby のテストフレームワーク
 * shoud とか should_not
 * expect(file '/etc/hoge') が推奨
 * オブジェクトに should を付けるのは非推奨

### 中身

 * シンプル
  * chkconfig とか叩いている
 * テスト対象に ssh してコマンドを叩く
  * ssh が使えればいい
  * ruby すら不要
 * シェル・コマンド実行によるサーバーのテストをスマートにやれるようにしたのが servespec  

## 質問

### （質）クラスタ構成をテストするようなことを想定されているか？また、今後、サポートすることがあるか？

 * MySQL のレプリケーション構成等の複数のサーバーで構成された環境におけるフェールオーバー等のテスト
 * 他の勉強会で質問を受けてしまった...

### （質）複数台のサーバーをテストする場合の挙動

 * おそらく順番にテストしていくと仮定していますが、実際は？
 * パラレルでテストを行う場合、どのような手法がオススメか？
  * capistrano を絡ませる
 
### （質）spec ファイルの使い回しについて

 * 共通の spec はシンボリックリンクで運用していますが、どう思われますか？

