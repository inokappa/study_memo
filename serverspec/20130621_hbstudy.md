# hbstudy serverspecが拓いたサーバテストの世界

## 自己紹介

 * mizzy さん
 * 学生
 * puppet のススメ
 * 子沢山

***

## サーバープロビジョニング

### Provisioning Toolchain

 * Bootstrapping
 * Coniguration（puppet chef）-> serverspec
 * Orchestration（capistrano…）-> Nagios zabbix

### サーバープロビジョニングとテスト

 * 監視とは継続的なテストである
 * zabbix や Nagios で apache を監視する場合
 * serverspec で apache を監視する場合
  * httpd プロセスが動いているか？
  * 自動起動するか？
  * パッケージがインストールされているか？
 * configuration のテスト
 * Nagios とか Zabbix があれば servespec は不要論

***

## Configuration とテスト

### serverspec 登場前？

 * シェル叩く
 * ブラウザでアクセスする
 
## configuration management framework

 * puppet
 * chef
 * ansible works（？）
  * オーケストレイヤーも含む？

## configuration management framework と test

 * 従来はシェル

### この界隈はテスト・ツールが乱立？

 * シンタックステスト
  * foodcritic
  * cookbook test
  
 * ユニットテスト
  * Chefspec（ユニットテスト）
  * rspec-puppet（ユニットテスト）
  * 実際には適用しない
  * ユニットテスト要不要？
  * 複雑なモノであれば威力を発揮→ユニットテスト
 
 * 結合テスト
  * serverspec
  * test kitchen
  * cucumber chef

 * Instructure as code は自然の流れ

### なぜ、serverspec を作ったか？

 * 既存のツールは機能が多い
 * 特定の環境に依存しない
 * test-kitchen と serverspec の組み合わせが良いらしい
 
### puppet や chef を使っていて servespec が必要か？

 * 一度書いたマニフェストやレシピを更新しないのであれば不要（たぶん）
 * 継続的に更新するなら必要
 * プログラムのリファクタリングと一緒
 * テストの自動化が必要
 * 自動化するならコードに落としこむ
 * テストコード自体のメンテナンスも必要
 * テストコードの読みやすさ、テストツール自体のシンプルさも重要

***

## serverspec

 * サーバーのテストを簡潔に書くための仕組み
 * rspec で記述
 * rspec は ruby のテストフレームワーク
 * shoud とか should_not
 * expect(file '/etc/hoge') が推奨
 * オブジェクトに should を付けるのは非推奨

### 中身

 * シンプル
  * chkconfig とか叩いている
 * テスト対象に ssh してコマンドを叩く
  * ssh が使えればいい
  * ruby すら不要
 * シェル・コマンド実行によるサーバーのテストをスマートにやれるようにしたのが servespec  

### serverspec の始め方

 * さくっとインストール
 * さくっとデモ
 * serverspec-init
 * spec_helper
  * DetectOS で OS を自動判別する
  * .ssh/config の設定を読み込む
  * :user をユーザー名で書き換えても良い
 * local を選ぶと ssh 関連の設定は入らない
 * --color オプションを付けると見やすい
 * --fomat s オプションを付けると何が成功しているかがわかる
 * テストドリブン
  * テストしてサーバーを構築していく
 
### serverspec が産まれた経緯

 *  2007 年に puppet を導入することにした
 * puppet でサーバー構築の自動化出来ました
 * じゃあ、テストはどうするか？
  * テスト報告書
 * Assurer（Perl で書いた）
  * 多機能で実用に耐えなかった
 * 2013 年
  * puppet マニフェストのリファクタリングをやろうと思った
  * puppet の最近のベストプラクティスはモジュール化
 * rspec-puppet はモジュールのテストにしか使えない
 * puppet 適当後の状態のサーバーをテストしたい
 * @hiboma さん
   * LXC で構築したサーバー（コンテナ）をテストしてた
 * ぱくって gem にしよう
 * サクッと作って、さくっと gem にした
 * localhost は考慮されず、RedHat 系のみを対象にした

***

## もう少し詳しい serverspec の話

### リソースタイプ

 * サーバー上のリソース（commnad とか cron とか...）
 * マッチャー
 * ディレクトリもファイルの一つ

### 複数 OS

 * BSD 系は非対応
 * 使ってる人が居ない…

### tips

 * root 権限（sudo をつけてコマンド実行）
 * path を追加することが出来る
 * pre_command を実行してから...
 * 将来変わるかも...
 * 詳しくは web で
 * Advanced Tips

*** 
 
## インフラの継続的インテグレーション（ukigumo）

 * CI 環境
 * テストの結果をまとめてくれる
 * IRC に飛ばしてくれる
 * 全体を壊していないかを確認することが必要
 
***

## プログラム内部の話

### file

```
describe file ("hoge") do
  it {}
end
```

 * file.rb と exec.rb と redhat.rb が呼ばれる
 
### backend::ssh と backend::exec

 * ret=ssh.exec!(command)
 * OS ごとの切り替え
 * リモートかローカルか
 
### chain

 * .by ('gem')
 
### serverspec 自体のテスト

### github でのコントリビュート

 * 日本語で OK
 * 途中でプルリク OK
  * [Working In Progress]
 * 動作確認は自分が使っている OS だけで OK
 * テストも書いてね（テストも書いてくれると嬉しい）
 * 書き方が解らなければご相談を 

***

## まとめ

 * 簡潔さが重要
 * ビジネス要件が重要で複雑
 * 継続的にテスト
 * テスト自体が複雑になる

### serverspec とは

 * システムのあるべき状態を簡潔に記述する
 
## おまけ

 * WEB+DB Press
 * Test-Driven Instructure…2nd Edition

***

## 質問

聞きたかったけど聞かなかった質問達。

### （質）contain の返り値はどこまで見ているのか？

 * 完全一致？
 * 部分一致？

### （質）クラスタ構成をテストするようなことを想定されているか？また、今後、サポートすることがあるか？

 * MySQL のレプリケーション構成等の複数のサーバーで構成された環境におけるフェールオーバー等のテスト
 * 他の勉強会で質問を受けてしまった...

### （質）複数台のサーバーをテストする場合の挙動

 * おそらく順番にテストしていくと仮定していますが、実際は？
 * パラレルでテストを行う場合、どのような手法がオススメか？
  * capistrano を絡ませる
 
### （質）spec ファイルの使い回しについて

 * 共通の spec はシンボリックリンクで運用していますが、どう思われますか？

### （質）ペパボで実運用してますか？

 * 一部で使ってます